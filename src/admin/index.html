<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <title>Content Manager</title>
    <!-- Define our function to fetch the signature and set Uploadcare settings -->
    <script>
      function initUploadcare() {
        fetch('/.netlify/functions/uploadcare-signature')
          .then(function(res) {
            return res.json();
          })
          .then(function(data) {
            const { secureSignature, secureExpire } = data;
            if (window.uploadcare && window.uploadcare.settings) {
              window.uploadcare.settings.set('secureSignature', secureSignature);
              window.uploadcare.settings.set('secureExpire', secureExpire);
              console.log('âœ… Uploadcare secure settings applied globally.');
            } else {
              console.error('Uploadcare is not available yet:', window.uploadcare);
            }
          })
          .catch(function(err) {
            console.error('ðŸ”´ Failed to fetch Uploadcare signature:', err);
          });
      }
    </script>
  </head>
  <body>
    <!-- Load Uploadcare synchronously (removed async) so itâ€™s available immediately -->
    <script
      src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"
      data-uploadcare-public-key="4bb2bfa91b9bf261537f"
      onload="initUploadcare();">
    </script>

    <!-- Decap CMS -->
    <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.6.2/dist/decap-cms.js"></script>

    <!-- Custom Widgets (if any) -->
    <script src="/admin/custom-widgets/mywidget.js"></script>
    <script src="/admin/custom-widgets/listingspreview.js"></script>
    <script src="/admin/custom-widgets/BulkImageUploadWidget.js"></script>
    
    <!-- Any additional custom scripts -->
    <script>
      window.addEventListener("message", function (e) {
        if (e.data && e.data.action === "focusListingByAddress") {
          var targetAddress = e.data.address.trim();
          var container = document.getElementById("listings-field-1");
          if (!container) {
            console.warn("No listings container (id='listings-field-1') found");
            return;
          }
          
          var escapedAddress = targetAddress.replace(/'/g, "\\'");
          var xpath = ".//div[normalize-space(text()) = '" + escapedAddress + "']";
          var result = document.evaluate(xpath, container, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
          
          if (result.snapshotLength === 0) {
            console.warn("No element found with address:", targetAddress);
            return;
          }
          
          var addressElement = result.snapshotItem(0);
          var current = addressElement;
          var listingContainer = null;
          while (current && current !== container) {
            var possibleBtn = current.querySelector("button");
            if (possibleBtn && possibleBtn.querySelector("svg")) {
              listingContainer = current;
              break;
            }
            current = current.parentElement;
          }
          
          if (listingContainer) {
            var expandBtn = listingContainer.querySelector("button");
            if (expandBtn) {
              expandBtn.click();
              listingContainer.scrollIntoView({ behavior: "smooth", block: "center" });
            } else {
              console.warn("No expand button found in the listing container for address", targetAddress);
            }
          } else {
            console.warn("No listing container found for address", targetAddress);
          }
        }
      });
    </script>
  </body>
</html>
