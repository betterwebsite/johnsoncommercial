<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Netlify Identity (if you use it) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <title>Content Manager</title>
  </head>
  <body>
    <!-- 1. Load Uploadcare synchronously -->
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"
      data-uploadcare-public-key="4bb2bfa91b9bf261537f"
      onload="initUploadcareAndLoadCMS();">
    </script>
  
    <script>
      function initUploadcareAndLoadCMS(){
        // 2. Fetch your secure signature from your Netlify function
        fetch('/.netlify/functions/uploadcare-signature')
          .then(function(response) {
            return response.json();
          })
          .then(function(data){
            var secureSignature = data.secureSignature;
            var secureExpire = data.secureExpire;
            // 3. Apply secure settings via uploadcare.start()
            if(window.uploadcare && typeof window.uploadcare.start === "function"){
              window.uploadcare.start({
                secureSignature: secureSignature,
                secureExpire: secureExpire
              });
              console.log("âœ… Uploadcare secure settings applied globally via start().");
              
              // 4. Now that secure settings are applied, load Decap CMS.
              var cmsScript = document.createElement("script");
              cmsScript.src = "https://cdn.jsdelivr.net/npm/decap-cms@3.6.2/dist/decap-cms.js";
              cmsScript.onload = function(){
                console.log("âœ… Decap CMS loaded.");
              };
              document.body.appendChild(cmsScript);
            } else {
              console.error("Uploadcare is not available to call start().", window.uploadcare);
            }
          })
          .catch(function(err){
            console.error("ðŸ”´ Failed to fetch Uploadcare signature:", err);
          });
      }
    </script>
    
    <!-- Load your custom widgets after CMS is loaded -->
    <script src="/admin/custom-widgets/mywidget.js"></script>
    <script src="/admin/custom-widgets/listingspreview.js"></script>
    <script src="/admin/custom-widgets/BulkImageUploadWidget.js"></script>
    
    <!-- Additional custom scripts remain unchanged -->
    <script>
      window.addEventListener("message", function(e) {
        if (e.data && e.data.action === "focusListingByAddress") {
          var targetAddress = e.data.address.trim();
          var container = document.getElementById("listings-field-1");
          if (!container) {
            console.warn("No listings container (id='listings-field-1') found");
            return;
          }
          
          var escapedAddress = targetAddress.replace(/'/g, "\\'");
          var xpath = ".//div[normalize-space(text()) = '" + escapedAddress + "']";
          var result = document.evaluate(xpath, container, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
          
          if (result.snapshotLength === 0) {
            console.warn("No element found with address:", targetAddress);
            return;
          }
          
          var addressElement = result.snapshotItem(0);
          var current = addressElement;
          var listingContainer = null;
          while (current && current !== container) {
            var possibleBtn = current.querySelector("button");
            if (possibleBtn && possibleBtn.querySelector("svg")) {
              listingContainer = current;
              break;
            }
            current = current.parentElement;
          }
          
          if (listingContainer) {
            var expandBtn = listingContainer.querySelector("button");
            if (expandBtn) {
              expandBtn.click();
              listingContainer.scrollIntoView({ behavior: "smooth", block: "center" });
            }
          }
        }
      });
    </script>
  
  </body>
</html>
